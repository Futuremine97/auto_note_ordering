version: "3.9"
services:
  db:
    image: postgres:16
    container_name: page_ocr_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - page_ocr_data:/var/lib/postgresql/data

  backend:
    build:
      context: ./backend
    container_name: page_ocr_backend
    environment:
      DATABASE_URL: ${DATABASE_URL}
      UPLOAD_DIR: /data/uploads
      TESSERACT_LANG: ${TESSERACT_LANG:-eng+kor+jpn}
      OCR_WORKERS: ${OCR_WORKERS:-4}
      PHOTO_PASSWORD: ${PHOTO_PASSWORD:-}
      AUTH_SECRET: ${AUTH_SECRET:-change-me}
      AUTH_COOKIE_SECURE: ${AUTH_COOKIE_SECURE:-true}
      AUTH_COOKIE_TTL_HOURS: ${AUTH_COOKIE_TTL_HOURS:-72}
      LLM_PROVIDER: ${LLM_PROVIDER:-}
      LLM_API_BASE: ${LLM_API_BASE:-}
      LLM_API_KEY: ${LLM_API_KEY:-}
      LLM_MODEL: ${LLM_MODEL:-}
      LLM_CHAT_ENDPOINT: ${LLM_CHAT_ENDPOINT:-}
      LLM_MAX_CONTEXT_CHARS: ${LLM_MAX_CONTEXT_CHARS:-80000}
      LLM_MAX_IMAGE_CHARS: ${LLM_MAX_IMAGE_CHARS:-2000}
      LLM_TIMEOUT: ${LLM_TIMEOUT:-60}
      LLM_MAX_IMAGES: ${LLM_MAX_IMAGES:-12}
      LLM_IMAGE_MAX_BYTES: ${LLM_IMAGE_MAX_BYTES:-800000}
      LLM_IMAGE_MAX_DIM: ${LLM_IMAGE_MAX_DIM:-1024}
    volumes:
      - uploads:/data/uploads
    depends_on:
      - db

  nginx:
    build:
      context: .
      dockerfile: nginx/Dockerfile
    container_name: page_ocr_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    depends_on:
      - backend

volumes:
  page_ocr_data:
  uploads:
